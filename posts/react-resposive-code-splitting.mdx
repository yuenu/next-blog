---
title: Reactå¦‚ä½•åœ¨åŒä¸€å€‹Repoç”¨æ‹†åˆ†ä¸åŒè£ç½®çš„Code
subtitle: Desktop èˆ‡ Mobile(h5)ç‰ˆæœ¬ï¼Œä½¿ç”¨ä¸åŒçš„domainï¼Œä¹Ÿæ‹†åˆ†äº†ä¸åŒçš„å°ˆæ¡ˆï¼Œè¦å¦‚ä½•æ•´åˆåœ¨åŒä¸€å€‹å°ˆæ¡ˆå…§ï¼Ÿ
image: /images/post/react-resposive-code-splitting/post.jpg
date: 2023-05-24
slug: react-resposive-code-splitting
tags: react/Code-Splitting/React Lazy/React Suspense
published: true
---

[æ­¤æ–‡ç« çš„ Demo](https://react-code-splitting-example-self.vercel.app/)

[æ­¤æ–‡ç« çš„ Code](https://github.com/yuenu/react-code-splitting)

## æ­¤æ–‡ç« é©ç”¨ä»¥ä¸‹æƒ…å¢ƒ

- æ²’æœ‰ç‰¹åˆ¥è£½ä½œ RWD çš„ç¶²é ï¼Œæ˜¯ç¶­æŒå…©å€‹ç‰ˆæœ¬ï¼Œ`é›»è…¦ç‰ˆ`ã€`æ‰‹æ©Ÿç‰ˆ`

- é›»è…¦ç‰ˆèˆ‡æ‰‹æ©Ÿç‰ˆç”¨åˆ°çš„ API åŠå•†æ¥­é‚è¼¯å¤§è‡´ç›¸åŒï¼Œä½†æ˜¯å»æ‹†åˆ†äº† 2 å€‹å°ˆæ¡ˆï¼Œä¹Ÿå„è‡ªä¸Šå‚³åˆ°ä¸åŒçš„ Domain

- 2 å€‹ä¸åŒçš„å°ˆæ¡ˆç”±`+3`å€‹äººåŒæ™‚ç¶­è­·ï¼Œç¶­è­·äººå“¡åƒå·®ä¸é½Š

- æ²’æœ‰ç‰¹åˆ¥ç‚ºæ¯å€‹ core functionã€component å¯«æ¸¬è©¦

- æ²’æœ‰ç‰¹åˆ¥çš„äººå“¡ä¾†åš Code review

## æ¡ˆä¾‹åˆ†æ

### ç¶­è­·å•é¡Œ

A å°ˆæ¡ˆ(é›»è…¦ç‰ˆã€Desktop version)

B å°ˆæ¡ˆ(æ‰‹æ©Ÿç‰ˆã€Mobile version)

å°ˆæ¡ˆæœƒæ‹†åˆ†æˆ 2 å€‹ä¸åŒçš„å°ˆæ¡ˆï¼Œæ‰€ä»¥è‹¥è¦åŠ ä¸Šæ–°åŠŸèƒ½çš„è©±å¿…é ˆå…©å€‹å°ˆæ¡ˆéƒ½è¦ç¶­è­·ï¼Œè¦–å°ˆæ¡ˆå¤§å°æœ‰å¯èƒ½æœƒæœ‰ä¸åª 2 ä½ä»¥ä¸Šäººå“¡åŒæ™‚åœ¨ç¶­è­·ï¼Œä¸¦ä¸”äº¤å‰ç¶­è­·(åŒæ™‚ç¶­è­· A å°ˆæ¡ˆåŠ B å°ˆæ¡ˆ)ï¼Œè‹¥æ²’æœ‰åšå¥½ä»£ç¢¼ç®¡ç†çš„è©±ï¼Œå¾ŒçºŒçš„ç¶­è­·æœƒæ˜¯ä¸€å€‹å¤§ç½é›£

> åŸºæœ¬ä¸Šæœƒé‡åˆ°é€™ç¨®å°ˆæ¡ˆé¡å‹çš„éƒ½æ˜¯æ¯”è¼ƒèˆŠçš„å°ˆæ¡ˆï¼Œå› ç‚ºé‚£æ™‚å€™æ¯”è¼ƒæ²’æœ‰[RWD](https://zh.wikipedia.org/zh-tw/%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BD%91%E9%A1%B5%E8%AE%BE%E8%AE%A1)çš„æ¦‚å¿µï¼ŒåŠ ä¸Šæ‰‹æ©Ÿç«¯çš„ç”¨æˆ¶èˆˆèµ·ï¼Œæ¯å€‹ç¶²ç«™éƒ½å¿…é ˆè¦æ”¯æ´æ‰‹æ©Ÿç«¯çš„ç¶²é ï¼Œå› æ­¤åŸæœ¬åªæœ‰è¨­è¨ˆé›»è…¦ç‰ˆçš„å…¬å¸åœ¨ä¸å¹²æ“¾åŸæœ¬ç¨‹å¼ç¢¼çš„æƒ…å½¢ï¼Œä¾¿åˆ©ç”¨è¦–çª—å¤§å°ä¾†ç¢ºèªã€‚æ‰€ä»¥ä¾¿æ‹†åˆ†äº†å…©ç¨®ç‰ˆæœ¬ï¼Œè€Œéš¨è‘—å°ˆæ¡ˆè¶Šä¾†è¶Šå¤§ä¹Ÿç„¡æ³•éš¨æ„åˆä½µåœ¨ä¸€èµ·ï¼Œä¹‹å¾Œè¶Šèµ°è¶Šé ç›´è‡³å¹³è¡Œã€‚

åŸºæœ¬ä¸Šé‡åˆ°é€™ç¨®æƒ…æ³åŠ ä¸Šç”¢å“é‚„åœ¨ç·šä¸Šçš„ï¼Œä¸å¯èƒ½æ”¹å°ˆæ¡ˆæ¶æ§‹ã€‚é™¤éé‡åˆ°å…¬å¸æ¥­ç¸¾å¤§å¹…è¡°é€€ï¼Œè€é—†ç™¼è¦ºä¸å¦™æ‰æœ‰å¯èƒ½é€²è¡Œä¸€äº›èª¿æ•´ã€‚

> è¦æ”¹çš„æ±è¥¿å¤ªå¤šäº†ï¼Œé‚£å°±æ”¹å¤©å§

ä½†åœ¨é€™éº¼è¬›ä¹Ÿä¸å¯èƒ½ç›´æ¥æ”¹æ¶æ§‹ï¼Œå› ç‚ºç”¢å“è¦è€ƒæ…®çš„é¢å‘å¤ªå¤šäº†ã€‚æ‰€ä»¥æˆ‘å€‘å¯ä»¥å¾æ–°å°ˆæ¡ˆé–‹å§‹ä½¿ç”¨é€™æ¨£çš„æ¶æ§‹ä¾†é¿å…æœªä¾†é¢è‡¨çš„æŠ€è¡“å‚µ

~~è¦æ”¹ï¼Ÿè€é—†èµ°~~

~~ä¸æ”¹ï¼Ÿä½ èµ°~~

### ä½¿ç”¨è€…é«”é©—å•é¡Œ

å¦‚ï¼š

- ç¶²å®¶ PCHome(Desktop) [https://24h.pchome.com.tw/](https://24h.pchome.com.tw/)

- ç¶²å®¶ PCHome(Mobile) [https://24h.m.pchome.com.tw/](https://24h.m.pchome.com.tw/)

- iT é‚¦å¹«å¿™(Desktop) [https://ithelp.ithome.com.tw/](https://ithelp.ithome.com.tw/)

- iT é‚¦å¹«å¿™(Mobile) [https://ithelp.ithome.com.tw/m/](https://ithelp.ithome.com.tw/m/)

å¯ä»¥è§€å¯Ÿåˆ°ä»¥ä¸Šç¶²å€ç„¡éå°±æ˜¯åœ¨ Domain ä¸ŠåŠ ä¸Š m ç•¶ä½œ mobile çš„æ¨™èªŒ

åœ¨ä¸€èˆ¬çš„æƒ…æ³ä¸‹é€™ç¨®æ–¹å¼æ˜¯æ²’æœ‰å•é¡Œçš„ï¼Œä½†æ˜¯å‡å¦‚ä½ åœ¨é›»è…¦ä¸Šé–‹äº†æ‰‹æ©Ÿç‰ˆçš„ Domain ï¼Œé é¢ä¾¿æœƒè®Šå¾—éå¸¸å¥‡æ€ª

![PC Home mobile page](/images/post/react-resposive-code-splitting/pchome.png)

åœ¨ SEO æ¬Šé‡çš„åˆ†é…ä¸‹æœ‰å¯èƒ½ Mobile çš„ Domain ä¸Šåˆ°äº†æœå°‹çµæœçš„ç¬¬ä¸€é ï¼Œç”¨æˆ¶é»äº†é é¢ä»¥ç‚ºæ­¤ç¶²ç«™æœ‰å•é¡Œï¼Œå°±ç›´æ¥é—œæ‰æ­¤ç¶²é 

![ithelp mobile page](/images/post/react-resposive-code-splitting/ithelp.png)

> æˆ‘å° SEO ç›¸é—œçš„å„ªåŒ–ä¸æ˜¯å¤ªäº†è§£ ğŸ˜“ ï¼Œä¹‹å‰çš„å·¥ä½œéƒ½æ˜¯ä½¿ç”¨ CSR(Client side render)çš„æ¡†æ¶

å°æ–¼ä»€éº¼æ˜¯ CSR é‚„æ˜¯ SSR é€™äº›åè©çš„äººï¼Œå¯ä»¥çœ‹é€™ [è‹±æ–‡](https://web.dev/rendering-on-the-web/)ã€[ç¹é«”ä¸­æ–‡](https://shubo.io/rendering-patterns/)ã€[æ˜é‡‘](https://juejin.cn/post/7127426806088466446)

## æ­£é¡Œé–‹å§‹ Show me the code

æ­¤ç¯‡ä¸¦æ²’æœ‰æ‰“ç®—ä½¿ç”¨ monorepo ç›¸é—œçš„æ¡†æ¶ä¾†è™•ç†ï¼Œä¸»è¦ä½¿ç”¨çš„æŠ€è¡“ç‚º

- [Vitejs](https://vitejs.dev/)

- [React.js](https://react.dev/)

> ä½†è‹¥ä½ æœ‰è€ƒæ…®ä½¿ç”¨ monorepo ï¼Œå¯ä»¥è€ƒæ…®[lerna](https://lerna.js.org/)ã€[Nx](https://nx.dev/)ã€[Turborepo](https://turbo.build/)ï¼Œå„æ¡†æ¶éƒ½æœ‰å„è‡ªçš„ trade offã€‚

æ­¤ç¯„ä¾‹ç”¨çš„ library ç‰ˆæœ¬ï¼Œä¸»è¦ç”¨ `Typescript` ï¼Œç”¨ js çš„å°å¤¥ä¼´å¯ä»¥è‡ªå·±åœ¨åšèª¿æ•´

```bash
# bash
â¯ node -v
v14.19.1
â¯ npm -v
7.24.2
```

Run `npm create vite@latest` å¾Œçš„ package.json

```json
// package.json
{
  // ...
  "dependencies": {
    "react": "^18.2.0",
    "react-dom": "^18.2.0"
  },
  "devDependencies": {
    "vite": "^4.3.2"
  }
}
```

æ¥è‘—å®‰è£ React-router-dom åŠ @types/node

> React router è‡ªå¾ 6.4 ç‰ˆæœ¬å¾Œåšäº†è¨±å¤šæ”¹è®Šï¼Œä¹Ÿè¨±ä½ è©²çœ‹çœ‹ä»–å€‘çš„[æ–‡æª”](https://reactrouter.com/) ï¼Œ ä½†ç¾éšæ®µä¸å»ºè­°ä½¿ç”¨åœ¨ Prod ä¸Šé¢ï¼Œå› ç‚ºè¿‘æœŸä»–å€‘å°ç‰ˆæœ¬æ›´æ–°çš„é£›å¿«ï¼Œå¦‚æœè¦ç©©å®šä¸€é»çš„ç‰ˆæœ¬å»ºè­°é‚„æ˜¯ä½¿ç”¨ v5 ï¼Œé‡åˆ°å•é¡Œç¤¾ç¾¤ä¸Šçš„è§£ç­”ä¹Ÿç›¸å°æ¯”è¼ƒå¤šä¸€é»ã€‚

```bash
yarn add react-router-dom && yarn add -D @types/node
```

å®‰è£å®Œå¾Œæœƒè®Šæˆ

```json
// package.json
{
  // ...
  "dependencies": {
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "react-router-dom": "^6.11.2"
  },
  "devDependencies": {
    "@types/node": "^20.2.3",
    "vite": "^4.3.2"
  }
}
```

æ¥è‘—èª¿æ•´ä¸€ä¸‹ vite.config.ts ä»¥åŠ tsconfig.json

```ts
// vite.config.ts
/** @type {import('vite').UserConfig} */

import { URL, fileURLToPath } from 'node:url'
import react from '@vitejs/plugin-react'
import { defineConfig } from 'vite'

// https://vitejs.dev/config/
export default defineConfig({
  plugins: [react()],
  resolve: {
    alias: [
      {
        find: '@',
        replacement: fileURLToPath(new URL('./src', import.meta.url)),
      },
    ],
  },
})
```

```json
// tsconfig.json
{
  "compilerOptions": {
    // ....
    // åŠ ä¸Šé€™å…©è¡Œï¼Œè®“ vscodeï¼Œèƒ½å¤ è‡ªå‹•æŠ“åˆ°ç›¸å°æ‡‰çš„è·¯å¾‘
    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"]
    }
  }
}
```

.eslintrc.cjs æœƒå™´éŒ¯ï¼Œå…ˆä¿®æ­£ä¸€ä¸‹

> 'module' is not defined. eslint (no-undef)

```js
// .eslintrc.cjs
module.exports = {
  env: { browser: true, es2020: true, node: true }, // åŠ ä¸Š node: true
  // ...
}
```

åˆ°é€™é‚Šå°ˆæ¡ˆçš„åˆå§‹è¨­å®šç®—æ˜¯å¥½äº†

---

### ä¸»é‚è¼¯

ä¸»è¦æ˜¯åˆ©ç”¨äº†[React.lazy](https://react.dev/reference/react/lazy) dynamic import çš„åŠŸèƒ½ï¼Œç›¡å¯èƒ½æŠŠ bundle size å£“åˆ°æœ€å°ï¼Œè®“ç”¨æˆ¶åœ¨åˆå§‹è¼‰å…¥çš„é€Ÿè®€æå‡ã€‚

åœ¨æ­é…[react-responsive](https://github.com/yocontra/react-responsive)ï¼Œåˆ¤æ–·ç”¨æˆ¶è¦–çª—å¤§å°ä¾†è¼‰å…¥æ˜¯ Desktop é‚„æ˜¯ Mobile çš„æª”æ¡ˆ

> React Suspense & React Lazy ç‚º 16.6 ä»¥å¾Œçš„ç‰ˆæœ¬æ‰æœ‰çš„åŠŸèƒ½

`ä»¥ä¸‹ç‚ºè³‡æ–™å¤¾çµæ§‹`

- ./src/\* ï¼Œå…±ç”¨çš„é‚è¼¯ Hooksã€APIã€componentsã€storeã€utils
- ./src/apps/Desktop ï¼Œ é›»è…¦ç‰ˆçš„é‚è¼¯ï¼Œä¹Ÿå¯ä»¥æœ‰è‡ªå·±çš„ Hooksã€API
- ./src/apps/Mobile ï¼Œ æ‰‹æ©Ÿç‰ˆçš„é‚è¼¯ï¼Œä¹Ÿå¯ä»¥æœ‰è‡ªå·±çš„ Hooksã€API

```tree
â”œâ”€â”€ node_modules
â”œâ”€â”€ public
â”œâ”€â”€ src
â”‚   â”œâ”€â”€ apps
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ index.tsx // å°å‡º Desktop & Mobile
â”‚   â”‚   â”œâ”€â”€ Desktop
â”‚   â”‚   â”‚     â”œâ”€â”€ components  // é›»è…¦ç‰ˆçš„components
â”‚   â”‚   â”‚     â”œâ”€â”€ pages // é›»è…¦ç‰ˆçš„é é¢
â”‚   â”‚   â”‚     â”‚     â”œâ”€â”€ Home.tsx
â”‚   â”‚   â”‚     â”‚     â”œâ”€â”€ About.tsx
â”‚   â”‚   â”‚     â”‚     â””â”€â”€ Prod.tsx
â”‚   â”‚   â”‚     â”‚
â”‚   â”‚   â”‚     â”œâ”€â”€ App.tsx
â”‚   â”‚   â”‚     â”œâ”€â”€ index.tsx
â”‚   â”‚   â”‚     â””â”€â”€ router.tsx
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€  Mobile
â”‚   â”‚         â”œâ”€â”€ components // æ‰‹æ©Ÿç‰ˆçš„components
â”‚   â”‚         â”œâ”€â”€ pages // æ‰‹æ©Ÿç‰ˆçš„é é¢
â”‚   â”‚         â”‚     â”œâ”€â”€ Home.tsx
â”‚   â”‚         â”‚     â”œâ”€â”€ About.tsx
â”‚   â”‚         â”‚     â””â”€â”€ Prod.tsx
â”‚   â”‚         â”‚
â”‚   â”‚         â”œâ”€â”€ App.tsx
â”‚   â”‚         â”œâ”€â”€ index.tsx
â”‚   â”‚         â””â”€â”€ router.tsx
â”‚   â”‚
â”‚   â”œâ”€â”€ api  // å…±ç”¨çš„ API
â”‚   â”œâ”€â”€ components  // å…±ç”¨çš„ components
â”‚   â”œâ”€â”€ hooks  // å…±ç”¨çš„ hooks
â”‚   â”œâ”€â”€ store  // å…±ç”¨çš„ store
â”‚   â”œâ”€â”€ utils  // å…±ç”¨çš„ utils
â”‚   â”œâ”€â”€ App.tsx
â”‚   â”œâ”€â”€ index.css
â”‚   â””â”€â”€ main.tsx
â”‚
â”œâ”€â”€ .eslintrc.cjs
â”œâ”€â”€ .gitignore
â”œâ”€â”€ package.json
â”œâ”€â”€ package-lock.json
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ tsconfig.node.json
â””â”€â”€ vite.config.ts
```

Desktop çš„ code ï¼Œ Mobile çš„å°±ä¾æ¨£ç•«è‘«è˜† ï¼Œè‹¥æœ‰å•é¡Œè«‹çœ‹[demo repo](https://github.com/yuenu/react-code-splitting)

è·¯å¾‘: src/apps/Desktop/index.tsx

```js
// src/apps/Desktop/index.tsx
import React, { Suspense } from 'react'

import { LoadingSpinner } from '@/components/Loading'

const App = React.lazy(() => import('./App'))
const AsyncApp = () => {
  return (
    <Suspense fallback={<LoadingSpinner />}>
      <App />
    </Suspense>
  )
}
export default AsyncApp
```

è·¯å¾‘: src/apps/Desktop/router.tsx

```js
// src/apps/Desktop/router.tsx
import { Suspense, lazy } from 'react'
import { Route, Routes } from 'react-router-dom'

const Home = lazy(() => import('./pages/Home'))
const About = lazy(() => import('./pages/About'))
const Product = lazy(() => import('./pages/Product'))

const IRoute = () => {
  return (
    <Suspense>
      <Routes>
        <Route path="/" element={<Home />} />
        <Route path="/about" element={<About />} />
        <Route path="/product" element={<Product />} />
      </Routes>
    </Suspense>
  )
}

export default IRoute
```

è·¯å¾‘: src/apps/Desktop/App.tsx

```js
// src/apps/Desktop/App.tsx
import { BrowserRouter, Link } from 'react-router-dom'

import IRoute from './router'

const App = () => {
  return (
    <BrowserRouter>
      <h1>Desktop App component</h1>
      <Link to="/">Home</Link>
      <Link to="/about">About</Link>
      <Link to="/product">Product</Link>
      <IRoute />
    </BrowserRouter>
  )
}

export default App
```

è·¯å¾‘: src/apps/Desktop/pages/About.tsx

è·¯å¾‘: src/apps/Desktop/pages/Home.tsx

è·¯å¾‘: src/apps/Desktop/pages/Prodcut.tsx

```js
// src/apps/Desktop/pages/About.tsx
function About() {
  return (
    <div>
      <h1>This is the Desktop About page</h1>
    </div>
  );
}
export default About;

// src/apps/Desktop/pages/Home.tsx
function Home() {
  return (
    <div>
      <h1>This is the Desktop Home page</h1>
    </div>
  );
}
export default Home;

// src/apps/Desktop/pages/Prodcut.tsx
function Product() {
  return (
    <div>
      <h1>This is the Desktop Product page</h1>
    </div>
  );
}
export default Product;
```

---

ä»¥ä¸Šå°±èƒ½å»ºç«‹èµ· Desktop åˆå§‹çš„è³‡æ–™çµæ§‹äº†ï¼Œæ¥è‘— Mobile ä¹Ÿä¸€æ¨£åšæ³•
æ¥è‘—æˆ‘å€‘åˆ©ç”¨ react-responsive å¹«åŠ©æˆ‘å€‘åˆ¤æ–·ä»€éº¼æ™‚å€™è¦è¼‰å…¥å“ªä¸€å€‹ç‰ˆæœ¬çš„ code

```bash
yarn add react-responsive
```

è·¯å¾‘: src/hoc/responsive.tsx

```js
// src/hoc/responsive.tsx
import MediaQuery from 'react-responsive'

const MOBILE_QUERY = '(max-width: 767px)'

type ScreenProps = {
  Mobile: React.ElementType,
  Desktop: React.ElementType,
}

const Screen =
  ({ Mobile, Desktop }: ScreenProps) =>
  ({ ...rest }) =>
    (
      <MediaQuery query={MOBILE_QUERY}>
        {(matches) => (matches ? <Mobile {...rest} /> : <Desktop {...rest} />)}
      </MediaQuery>
    )

export default Screen
```

è·¯å¾‘: src/App.tsx

```js
import { Desktop, Mobile } from '@/apps'
import Responsive from '@/hoc/responsive'

function App() {
  const Screen = Responsive({ Desktop, Mobile })
  return (
    <div>
      <div>Root App Component</div>
      <Screen />
    </div>
  )
}

export default App
```

å·²ä¸Šå°±æ˜¯å…¨éƒ¨äº†ï¼Œä¸æ¸…æ¥šçš„å¯ä»¥å»çœ‹[dmoe](https://react-code-splitting-example-self.vercel.app/)ï¼Œé–‹ Network å»è§€å¯Ÿ

![deploy to real domain to check](/images/post/react-resposive-code-splitting/test.png)

## çµè«–

åˆ©ç”¨æ­¤æ¶æ§‹çš„å„ªé»æ˜¯å¯ä»¥å°‡å…±ç”¨çš„å•†æ¥­é‚è¼¯å¯«åœ¨ä¸€å€‹åœ°æ–¹å…±åŒç¶­è­·å°±å¥½ï¼Œå„è‡ªçš„ç‰ˆæœ¬å¯ä»¥å°ˆæ³¨æ–¼ç•«é¢ä¸Šçš„é‚è¼¯å°±å¥½ã€‚

æ­¤ç¯‡çš„æ–¹æ³•åªæ˜¯å€‹ç°¡å–®çš„ ğŸŒ° ï¼Œ ä½†é‚„æœ‰å¾ˆå¤šåœ°æ–¹å¯ä»¥é€²è¡Œå„ªåŒ–ã€‚ ä½†å‰©ä¸‹çš„åœ°æ–¹å°±ç•™çµ¦ä½ å€‘ç™¼æ®å•¦ï½
